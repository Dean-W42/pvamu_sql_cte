-- PULLS FROM CTE A

home    as (select       "home_pidm",coalesce(h1,h2,h3,h4,h5,h6,h7,h8)"home_phone"      
      from (select       "pidm" "home_pidm",   
           (select       "h1" from(select t.sprtele_pidm"h1_pidm",t.sprtele_phone_area||t.sprtele_phone_number"h1",row_number() over(partition by t.sprtele_pidm order by t.sprtele_surrogate_id desc nulls last) rn from saturn.sprtele@prod t where t.sprtele_primary_ind='Y' and t.sprtele_status_ind is null and t.sprtele_tele_code in('AA','AD','AH','BI','BU','FA','MA','PR','RH') and regexp_like(t.sprtele_phone_area,'^\d{3}$') and regexp_like(t.sprtele_phone_number,'^\d{7}$') and t.sprtele_pidm in(select "pidm" from a)) where rn=1 and "h1_pidm"="pidm") h1,
           (select       "h2" from(select u.sprtele_pidm"h2_pidm",u.sprtele_phone_area"h2",row_number() over(partition by u.sprtele_pidm order by u.sprtele_surrogate_id desc nulls last) rn from saturn.sprtele@prod u where u.sprtele_primary_ind='Y' and u.sprtele_status_ind is null and u.sprtele_tele_code in('AA','AD','AH','BI','BU','FA','MA','PR','RH') and regexp_like(u.sprtele_phone_area,'^\d{10}$') and u.sprtele_pidm in(select "pidm" from a)) where rn=1 and "h2_pidm"="pidm") h2,
           (select       "h3" from(select v.sprtele_pidm"h3_pidm",v.sprtele_phone_area||v.sprtele_phone_number"h3",row_number() over(partition by v.sprtele_pidm order by v.sprtele_surrogate_id desc nulls last) rn from saturn.sprtele@prod v where v.sprtele_status_ind is null and v.sprtele_tele_code in('AA','AD','AH','BI','BU','FA','MA','PR','RH') and regexp_like(v.sprtele_phone_area,'^\d{3}$') and regexp_like(v.sprtele_phone_number,'^\d{7}$') and v.sprtele_pidm in(select "pidm" from a)) where rn=1 and "h3_pidm"="pidm") h3,
           (select       "h4" from(select w.sprtele_pidm"h4_pidm",w.sprtele_phone_area"h4",row_number() over(partition by w.sprtele_pidm order by w.sprtele_surrogate_id desc nulls last) rn from saturn.sprtele@prod w where w.sprtele_status_ind is null and w.sprtele_tele_code in('AA','AD','AH','BI','BU','FA','MA','PR','RH') and regexp_like(w.sprtele_phone_area,'^\d{10}$') and w.sprtele_pidm in(select "pidm" from a)) where rn=1 and "h4_pidm"="pidm") h4,
           (select       "h5" from(select x.sprtele_pidm"h5_pidm",x.sprtele_phone_area||x.sprtele_phone_number||x.sprtele_phone_ext"h5",row_number() over(partition by x.sprtele_pidm order by x.sprtele_surrogate_id desc nulls last) rn from saturn.sprtele@prod x where x.sprtele_status_ind is null and x.sprtele_tele_code in('AA','AD','AH','BI','BU','FA','MA','PR','RH') and regexp_like(x.sprtele_phone_area,'^\d{3}$') and regexp_like(x.sprtele_phone_number,'^\d{3}$') and regexp_like(x.sprtele_phone_ext,'^\d{4}$') and x.sprtele_pidm in(select "pidm" from a)) where rn=1 and "h5_pidm"="pidm") h5,
           (select       "h6" from(select y.sprtele_pidm"h6_pidm",substr(y.sprtele_phone_number,-10)"h6",row_number() over(partition by y.sprtele_pidm order by y.sprtele_surrogate_id desc nulls last) rn from saturn.sprtele@prod y where y.sprtele_status_ind is null and y.sprtele_tele_code in('AA','AD','AH','BI','BU','FA','MA','PR','RH') and regexp_like(y.sprtele_phone_number,'^\d{12}$') and y.sprtele_pidm in(select "pidm" from a)) where rn=1 and "h6_pidm"="pidm") h6,
           (select       "h7" from(select z.sprtele_pidm"h7_pidm",z.sprtele_phone_number"h7",row_number() over(partition by z.sprtele_pidm order by z.sprtele_surrogate_id desc nulls last) rn from saturn.sprtele@prod z where z.sprtele_status_ind is null and z.sprtele_tele_code in('AA','AD','AH','BI','BU','FA','MA','PR','RH') and regexp_like(z.sprtele_phone_number, '^\d{10}$') and z.sprtele_pidm in(select "pidm" from a)) where rn=1 and "h7_pidm"="pidm") h7,            
           (select       "h8" from(select a.sprtele_pidm"h8_pidm",substr(a.sprtele_phone_area,1,4)||a.sprtele_phone_number"h8",row_number() over(partition by a.sprtele_pidm order by a.sprtele_surrogate_id desc nulls last) rn from saturn.sprtele@prod a where a.sprtele_status_ind is null and a.sprtele_atyp_code='AA' and regexp_like(a.sprtele_phone_area,'^\d{6}$') and regexp_like(a.sprtele_phone_number,'^\d{6}$') and a.sprtele_pidm in(select "pidm" from a)) where rn=1 and "h8_pidm"="pidm") h8
            from          a))
